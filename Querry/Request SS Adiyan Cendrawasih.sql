Declare @j as varchar(4);
set @j ='2017'

select distinct co.comp2_desc as Region, co.comp3_desc as Area, p.DISTRIBUTOR, dt.Name as 'Distributor Name', p.TOWN+p.LOCALITY+p.SLOCALITY+p.pop as 'LE Code', 
p.Name as 'Outlet Name',t.ldesc as TOWN, se.SUB_Channel as 'Oulet Channel Code', se.Chan as 'Outlet Channel Desc', 
case when active=1 then 'Active' when active=0 then 'Inactive' end as 'Outlet Status',
p.latitude,p.longitude,
ave.[AVG Per Week 2017], ave.[AVG Per Month 2017],
[012017],[022017],[032017],[042017],[052017],[062017],[072017],[082017],[092017],[102017],[112017],[122017],[132017],[142017],[152017],[162017],[172017],[182017],[192017],[202017],[212017],[222017],[232017],[242017],[252017],[262017],[272017],[282017],[292017],[302017],[312017],[322017],[332017],[342017],[352017],[362017],[372017],[382017],[392017],[402017],[412017],[422017],[432017],[442017],[452017],[462017],[472017],[482017],[492017],[502017],[512017],[522017],
[012018],[022018],[032018],[042018],[052018],[062018],[072018],[082018],[092018],[102018],[112018],[122018],[132018],[142018],[152018],[162018],[172018],[182018],[192018],[202018],[212018],[222018],[232018],[242018],[252018],[262018],[272018],[282018],[292018],[302018],[312018],[322018],[332018],[342018],[352018],[362018],[372018],[382018],[392018],[402018],[412018],[422018],[432018],[442018],[452018],[462018],[472018],[482018],[492018],[502018],[512018],[522018]
from pop p
join town t on t.town = p.town
join DISTRIBUTOR dt on dt.DISTRIBUTOR = p.DISTRIBUTOR 
--- join compcode
join (
select da.distributor, cl.comp2_desc, cl.comp3_desc from distributor_association da
join vw_complevel cl on da.value_comb = cl.compcode
join 
	( 
		select distinct DISTRIBUTOR, COUNT (DISTRIBUTOR) AS CNT from DISTRIBUTOR_ASSOCIATION
		where FIELD_COMB = 'compcode'
		group by DISTRIBUTOR
	) dbl on da.SEQ_NO= dbl.CNT and dbl.DISTRIBUTOR =da.DISTRIBUTOR
where field_comb = 'COMPCODE') co on co.distributor = p.distributor

join (select distinct SUB_ELEMENT, s.SUB_CHANNEL,  el.schan as Chan from SUB_ELEMENT s
      join ( select distinct e.ELEMENT, e.MASTER_CHANNEL, e.CHANNEL, e.SUB_CHANNEL, sc.LDESC as schan from ELEMENT e
			 join SUB_CHANNEL sc on e.MASTER_CHANNEL+e.CHANNEL+e.SUB_CHANNEL = sc.MASTER_CHANNEL+sc.CHANNEL+sc.SUB_CHANNEL
		)el	on s.MASTER_CHANNEL+s.CHANNEL+s.SUB_CHANNEL+s.ELEMENT = el.MASTER_CHANNEL+el.CHANNEL+el.SUB_CHANNEL+el.ELEMENT
      where SUB_ELEMENT in ('C10007','C10018','C10029','C10031','C16170')
)se on p.SUB_ELEMENT = se.SUB_ELEMENT

left join (
select distinct Distributor, LE, [012017],[022017],[032017],[042017],[052017],[062017],[072017],[082017],[092017],[102017],[112017],[122017],[132017],[142017],[152017],[162017],[172017],[182017],[192017],[202017],[212017],[222017],[232017],[242017],[252017],[262017],[272017],[282017],[292017],[302017],[312017],[322017],[332017],[342017],[352017],[362017],[372017],[382017],[392017],[402017],[412017],[422017],[432017],[442017],[452017],[462017],[472017],[482017],[492017],[502017],[512017],[522017],
[012018],[022018],[032018],[042018],[052018],[062018],[072018],[082018],[092018],[102018],[112018],[122018],[132018],[142018],[152018],[162018],[172018],[182018],[192018],[202018],[212018],[222018],[232018],[242018],[252018],[262018],[272018],[282018],[292018],[302018],[312018],[322018],[332018],[342018],[352018],[362018],[372018],[382018],[392018],[402018],[412018],[422018],[432018],[442018],[452018],[462018],[472018],[482018],[492018],[502018],[512018],[522018]
from
	(
		select Distributor, TOWN+LOCALITY+SLOCALITY+pop as LE, sum(NET_AMOUNT) as Net, jw.WEEK_NO+jw.YEAR week_no from cashmemo c
		join JC_WEEK jw on c.DOC_DATE between jw.START_DATE and jw.END_DATE
		where jw.YEAR in ('2017','2018')
		and VISIT_TYPE in ('02','01')
		group by Distributor, TOWN+LOCALITY+SLOCALITY+pop, jw.WEEK_NO+Jw.YEAR	
	) x
pivot
    (
      sum(Net) for week_no in ( [012017],[022017],[032017],[042017],[052017],[062017],[072017],[082017],[092017],[102017],[112017],[122017],[132017],[142017],[152017],[162017],[172017],[182017],[192017],[202017],[212017],[222017],[232017],[242017],[252017],[262017],[272017],[282017],[292017],[302017],[312017],[322017],[332017],[342017],[352017],[362017],[372017],[382017],[392017],[402017],[412017],[422017],[432017],[442017],[452017],[462017],[472017],[482017],[492017],[502017],[512017],[522017],
[012018],[022018],[032018],[042018],[052018],[062018],[072018],[082018],[092018],[102018],[112018],[122018],[132018],[142018],[152018],[162018],[172018],[182018],[192018],[202018],[212018],[222018],[232018],[242018],[252018],[262018],[272018],[282018],[292018],[302018],[312018],[322018],[332018],[342018],[352018],[362018],[372018],[382018],[392018],[402018],[412018],[422018],[432018],[442018],[452018],[462018],[472018],[482018],[492018],[502018],[512018],[522018])
    ) as PVT	
)n on p.DISTRIBUTOR = n.DISTRIBUTOR and p.TOWN+p.LOCALITY+p.SLOCALITY+p.pop = n.LE

left join (
select distinct Distributor, TOWN+LOCALITY+SLOCALITY+pop as LE, sum(NET_AMOUNT)/52 as 'AVG Per Week 2017', SUM(net_amount)/12 as 'AVG Per Month 2017' from cashmemo 
where YEAR(doc_date)='2017'
and VISIT_TYPE in ('02','01')
group by Distributor, TOWN+LOCALITY+SLOCALITY+pop
)ave on p.TOWN+p.LOCALITY+p.SLOCALITY+p.pop = ave.LE and p.distributor = ave.DISTRIBUTOR

where isnumeric(p.distributor)=1

--where p.SUB_ELEMENT in (select distinct SUB_ELEMENT from sub_ELEMENT where SUB_CHANNEL in (
--'C00120',
--'C00186'))

